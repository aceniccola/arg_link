# Revised LangGraph Flow using Gemini Function Calling

# --- Imports ---
import os
import re
import json
import argparse
from typing import List, Dict, Any, Optional, TypedDict
from models import high_thinking_model

from dotenv import load_dotenv
from langchain_core.messages import (
    SystemMessage,
    ToolMessage,
    AIMessage,
    HumanMessage,
    BaseMessage,
)
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnableConfig
from langgraph.graph import StateGraph, END, START
from langgraph.prebuilt import ToolNode  # Use prebuilt ToolNode
from langchain_google_vertexai import ChatVertexAI # Or ChatGoogleGenerativeAI

# Import your existing tools and CopilotKit specifics
from tools import tools  # Assuming tools.py defines your 'tools' list correctly
from copilotkit import CopilotKitState # Extends MessagesState
from copilotkit.langgraph import copilotkit_emit_state

# --- Configuration ---
load_dotenv()
# Assuming you have GOOGLE_API_KEY or relevant Vertex AI credentials set up
# Choose the appropriate Gemini model
# model_name = "gemini-1.5-flash-001" # Or another suitable model
model_name = "gemini-1.0-pro" # Example - choose based on availability/needs

# --- Models ---
# Use ChatVertexAI or ChatGoogleGenerativeAI which support function calling well
# Bind tools directly to the model
llm = high_thinking_model.bind_tools(tools)

# --- State Definition ---
# Inherit from CopilotKitState to keep UI integration
class ArgumentAnalysisState(CopilotKitState):
    """
    Represents the state of the argument analysis graph.
    Inherits from CopilotKitState for UI integration.

    Attributes:
        messages: The list of messages exchanged.
        argument: The original argument text.
        responses: The list of potential response texts or dicts.
        verified_responses: List of responses verified as relevant by the agent.
        tool_status: Dictionary to track tool usage for UI feedback.
    """
    argument: str
    responses: List[Dict[str, str]] # Assuming responses are dicts like {"heading": ..., "content": ...}
    verified_responses: Optional[List[Dict[str, str]]] = None
    tool_status: Dict[str, Any] = {} # For CopilotKit UI feedback

# --- Nodes ---

def argument_analyzer_node(state: ArgumentAnalysisState, config: RunnableConfig):
    """
    Analyzes the argument, identifies relevant responses, and potentially calls tools.
    Combines the original agent and verifier roles.
    """
    print("--- Entering Argument Analyzer Node ---")
    argument = state["argument"]
    responses = state["responses"]

    # Format the prompt for the LLM
    # Create a more structured prompt if needed, maybe sending responses as a numbered list
    response_content_list = [f"{idx + 1}. {resp.get('heading', '')}: {resp.get('content', '')}" for idx, resp in enumerate(responses)]
    prompt = f"""You are an expert legal analyst specializing in argument-response mapping.
Your task is to analyze the provided 'Argument' and determine which of the 'Potential Responses' directly address or counter the points made in the 'Argument'.

Argument:
---
{argument}
---

Potential Responses:
---
{chr(len(responses)).join(response_content_list)}
---

Instructions:
1. Carefully read the Argument and each Potential Response.
2. Identify any response relevent as a response to the argument at all. If you have any question regarding an argument, use tools to solve it.
3. If you need external information (e.g., definitions, case law details) to make a better judgment, use the available tools.
4. Output your final answer as a JSON object containing a single key "relevant_response_indices" with a list of the 1-based indices of the relevant responses. Remember to use no additional newlines. Example: {{"relevant_response_indices": [1, 3]}}
5. If no responses are relevant, return: {{"relevant_response_indices": []}}
6. If you use a tool, the next step will incorporate the tool's output. You will then be asked to provide the final JSON response based on the combined information. Do not output the JSON structure if you are calling a tool. Instead, explain why you need the tool.
"""
    # Append the user prompt to the message history if it's not already the last message
    # Or construct the message list dynamically for each invocation if preferred
    current_messages = state["messages"] + [HumanMessage(content=prompt)]

    # Invoke the LLM (which has tools bound)
    response_message = llm.invoke(current_messages, config=config)
    print(f"--- LLM Response: {response_message} ---")

    # Store the identified relevant responses (if no tool call)
    verified_responses_list = []
    if not response_message.tool_calls:
        try:
            # Attempt to parse the JSON output from the LLM content
            print("message content: ", response_message.content)
            messageio = response_message.content
                            # --- Start Modification: Strip Markdown Fences ---
            # Check for ```json ... ``` or ``` ... ```
            if messageio.startswith("```json") and messageio.endswith("```"):
                messageio = messageio[len("```json"): -len("```")].strip()
            elif messageio.startswith("```") and messageio.endswith("```"):
                 # Handle generic ``` case
                 messageio = messageio[len("```"): -len("```")].strip()
            # --- End Modification ---

            output_json = json.loads(messageio)
            relevant_indices = output_json.get("relevant_response_indices", [])
            # Convert 1-based indices to 0-based and retrieve responses
            verified_responses_list = [responses[i - 1] for i in relevant_indices if 0 < i <= len(responses)]
            print(f"--- Verified Responses (Indices: {relevant_indices}): {verified_responses_list} ---")
        except json.JSONDecodeError:
            print("--- Error: LLM did not return valid JSON. ---")
            # Handle error - maybe add a fallback message or retry logic
            # For now, add the raw response and proceed
            pass # Keep verified_responses_list empty or handle as needed

    return {
        "messages": [response_message], # Return only the new message for LangGraph state update
        "verified_responses": verified_responses_list if not response_message.tool_calls else state.get("verified_responses"), # Update only if final response
        "tool_status": {} # Reset tool status unless a tool is called
        }

# Use LangGraph's prebuilt ToolNode, but wrap it for CopilotKit state emission
# NOTE: LangGraph's ToolNode executes tools based on the *last* AIMessage.
# Our agent node returns *only* the new AIMessage, so this works.
tool_node = ToolNode(tools)

def wrapped_tool_node(state: ArgumentAnalysisState, config: RunnableConfig):
    """Wraps the LangGraph ToolNode to emit CopilotKit state updates."""
    print("--- Entering Tool Node ---")
    last_message = state["messages"][-1]
    tool_status_updates = {}

    if isinstance(last_message, AIMessage) and last_message.tool_calls:
        # Emit "processing" state before execution
        # Note: We don't know *which* tool will be called yet by ToolNode logic easily
        tool_status_updates = {"status": "processing", "tool": "unknown"}
        copilotkit_emit_state(config, {"tool_status": tool_status_updates})

        # Call the actual ToolNode
        output_state = tool_node.invoke(state) # ToolNode expects the full state

        # Emit "complete" or "error" state after execution
        # Check the output for ToolMessages or errors
        last_output_message = output_state["messages"][-1]
        if isinstance(last_output_message, ToolMessage):
             tool_status_updates = {"status": "complete", "tool": last_output_message.name}
        else:
             # Basic error assumption - enhance if ToolNode provides better error info
             tool_status_updates = {"status": "error", "tool": "unknown", "error": "Tool execution failed or produced unexpected output"}

        copilotkit_emit_state(config, {"tool_status": tool_status_updates})
        print(f"--- Tool Node Output State: {output_state} ---")
        return {**output_state, "tool_status": tool_status_updates} # Return the result from ToolNode + status

    else:
        # Should not happen if routing is correct, but handle defensively
        print("--- Tool Node Skipped (No tool calls in last message) ---")
        return {"tool_status": {"status": "skipped"}}


# --- Edges ---

def should_use_tools(state: ArgumentAnalysisState) -> str:
    """Determines whether the agent decided to call a tool."""
    print("--- Evaluating Edges ---")
    last_message = state["messages"][-1]
    if isinstance(last_message, AIMessage) and last_message.tool_calls:
        print("--- Decision: Use Tools ---")
        return "use_tools"
    print("--- Decision: End ---")
    return "__end__" # Use LangGraph's END constant

# --- Graph Definition ---
graph_builder = StateGraph(ArgumentAnalysisState)

graph_builder.add_node("analyzer", argument_analyzer_node)
graph_builder.add_node("tools", wrapped_tool_node) # Use the wrapped tool node

graph_builder.set_entry_point("analyzer")

# Conditional edge: After analyzer, check if tools are needed
graph_builder.add_conditional_edges(
    "analyzer",
    should_use_tools,
    {
        "use_tools": "tools",
        "__end__": END,
    },
)

# After tools are executed, return to the analyzer to process results
graph_builder.add_edge("tools", "analyzer")

# Compile the graph
app = graph_builder.compile()

# --- Example Invocation ---
# (Assuming 'argument' and 'responses' variables are loaded as in the original script)

# Load the data (ensure 'responses' is parsed correctly if it's a string)
argument ="heading: C. Count II: \"Violation of the Indiana Home Loan Practices Act\" Should be Dismissed for Failure to State a Claim. content: Count II fails to meet the federal pleading standards under Fed. R. Civ. P. 8 and Rule 9(b), and therefore should be dismissed.  The Indiana Home Loan Practices Act prohibits persons from engaging in deceptive acts in connection with mortgage transactions.  I.C. \u00a7 24-9-3-7(c)(3). To establish a \"deceptive act\" Plaintiff must show that as part of a mortgage transaction BANA knowingly or intentionally: (1) made a material misrepresentation; or (2) concealed material information regarding the terms or conditions of the transaction.  I.C. \u00a7 24-9-2-7; Collins v. America's Servicing Company, 652 F.3d 711, 715 (7th Cir. 2011).  \"Knowingly\" means having actual knowledge at the time of the transaction.  I.C. \u00a7 24-9-2-7.\nMerely reciting the elements of a cause of action without factual support, is not sufficient to state a claim.  Fed. R. Civ. P. 8.  To plead a cause of action demands more than an unadorned, \"the-defendant-unlawfully-harmed-me accusation\" or a \"sheer possibility that a defendant has acted unlawfully.\" Iqbal, 129 S.Ct. at 1949 (citing Twombly, 550 U.S. at 555-56).  It \"requires more than labels and conclusions, and a formulaic recitation of the elements of a cause of action will not do.\" Id. at 1954 (Rule 8 does not empower a defendant to plead the bare elements of a cause of action, affix the label \"general allegation\" and expect the complaint to survive a motion to dismiss), (citing Twombly, 550 U.S. at 555). Here, Plaintiff has failed to plead any facts to support his claim that BANA knowingly or intentionally made a material representation or concealed material information regarding the terms or conditions of his transaction, and instead merely concludes that BANA has done so.\nAdditionally, Plaintiff's claim under the IHLPA amounts to nothing more than allegations of misrepresentation or fraud; therefore, Plaintiff's claim must be pleaded with specificity. Fed. R. Civ. P. 9(b); Sears v. Likens, 912 F.2d 889, 893 (7th Cir. 1990) (ruling that officers failed to allege fraud with sufficient particularity where they neglected to \"state in any detail what misrepresentations were made by the defendant, to whom these misrepresentations were made, when these misrepresentations were made, or how these misrepresentations furthered the alleged fraudulent scheme.\"); see also DiLeo v. Ernst & Young, 901 F.2d 624 (7th Cir.1990). In other words, Rule 9(b) requires the plaintiff to include \"the 'who, what, when, and where' of the alleged fraud.\" Uni Quality, Inc. v. Infotronx, Inc., 974 F.2d 918, 923 (7th Cir.1992).  Here, Plaintiff fails to identify who made the alleged material misrepresentations, when, where, and about what.  Plaintiff merely states that \"[t]hroughout [BANA]'s interactions with [Plaintiff], [BANA] engaged in one or more deceptive acts...with respect to [Plaintiff]'s home loan.\"  [See \u00b6 60 of Plaintiff's Complaint].  Such a general allegation is utterly insufficient to inform the Court or BANA of what alleged acts constitute a knowing or intentional material misrepresentation under the Indiana Home Loan Practices Act. I.C. \u00a7 24-9-2-7.\nMoreover, to the extent Plaintiff claims BANA engaged in a deceptive act in relation to the May 28, 2009, conditional loan modification offer, Plaintiff cannot establish that BANA knowingly or intentionally made a material misrepresentation or concealed information, because the plain language of the conditional loan modification offer sets forth all requirements to perform and the consequences of not performing. Collins supra, 652 F3d. at 715.  The conditional loan modification offer required that the agreement be returned, signed and notarized, as well as the bankruptcy stay be lifted prior to June 11, 2009, and payments be made on the first of each month.  [See Exhibit C to Plaintiff's Complaint].  The conditional loan modification offer also expressly states that \"[i]n the event you do not or cannot fulfill ALL of the terms and conditions of this letter no later than June 11, 2009, we will continue our collections actions without giving you additional notices or response periods.\"  [See Exhibit C to Plaintiff's Complaint].\nPlaintiff's own rendition of the facts indicates he violated nearly every condition-he does not allege that he signed and returned the loan modification offer to BANA, and he states that he did not make the first payment by the deadline of July 1, 2009, but rather made his first payment nine months later on April 14, 2010.  [See \u00b6\u00b622 and 25 of Plaintiff's Complaint]. Plaintiff alleges however, that BANA received a payment on July 6, 2009, which even if this payment was made by Plaintiff, this late payment violated the terms.  Plaintiff also indicates there was no Bankruptcy related activity until October 2009, when the lifting of the stay needed to happen before June 11, 2009.  [See \u00b6\u00b6 20-25 of Plaintiff's Complaint and Exhibit C to Plaintiff's Complaint].\nAny allegation that BANA's collection actions constitute deceptive acts fails, as the conditional loan modification agreement specifically allows BANA to continue with collection actions, including foreclosure, in the event Plaintiff \"do[es] not or cannot fulfill ALL of the terms and conditions of the [conditional loan modification offer]\". Collins, 652 F3d. at 715; See Baker v. America's Mortgage Servicing, Inc., 58 F.3d 321, 328 (7th Cir.1995) (assessment of late fees under a mortgage agreement does not violate a state's consumer fraud statute if they are assessed in accordance with the express terms of the contract).  Therefore, Count II of Plaintiff's claim should be dismissed."

responses_list = [{
                    "heading": "IV. ARGUMENT",
                    "content": "Mr. Caines' Complaint should survive Defendant's Motion to Dismiss pursuant to Fed. R. Civ. P. 12(b)(6) because Defendant cannot meet the standard necessary to prevail."
                },
                {
                    "heading": "A. Count I: RESPA",
                    "content": "Count I of Mr. Caines' Complaint alleges violations of the Real Estate Settlement Procedures Act (RESPA).  It represents a legitimate claim upon which relief may be granted and it should not be dismissed."
                },
                {
                    "heading": "1. Mr. Caines' Request for Information Constituted a Proper QWR",
                    "content": "Defendant's first (half-hearted) argument for a shortcoming here is that the request for information sent by Mr. Caines did not constitute a proper qualified written request (QWR). This is not true.\n[It] takes a \"qualified written request\" to trigger the loan servicer's duties under RESPA to acknowledge and respond. The statute defines a qualified written request as written correspondence (other than notices on a payment coupon or similar documents) from the borrower or her agent that requests information or states reasons for the borrower's belief that the account is in error. 12 U.S.C. \u00a7 2605(e)(1)(B). To qualify, the written request must also include the name and account of the borrower or must enable the servicer to identify them. Id. Catalan v. GMAC Mortg. Corp., 629 F.3d 676, 680 (7th Cir. 2011).\nDefendant quotes Catalan as holding: \"Letters that 'merely dispute a debt or request information are not 'qualified written requests,' and do not trigger the obligations under section 2605.'\"  (Def.'s Br. in Supp. of Mot. to Dismiss 5-6).  Although they note that citations were omitted, Defendant mistakenly attributed this comment to the Court.  (Id. at 6).  Actually, this statement was part of the mortgage company's brief!  The citation omitted was \"GMAC Mortgage Br. 16.\"  Catalan, 629 F.3d at 686.  Defendant also omitted the first five words of the sentence that make it clear that the Court was not expressing its own opinion: \"GMAC Mortgage argues that the . . . \"  Id.\nThe Catalan Court's words actually reflect the opposite sentiment: \"Any reasonably stated written request for account information can be a qualified written request.\"  Id. at 867.\nRESPA does not require any magic language before a servicer must construe a written communication from a borrower as a qualified written request and respond accordingly. The language of the provision is broad and clear. To be a qualified written request, a written correspondence must reasonably identify the borrower and account and must \"include a statement of the reasons for the belief of the borrower, to the extent applicable, that the account is in error or provides sufficient detail to the servicer regarding other information sought by the borrower.\" 12 U.S.C. \u00a7 2605(e)(1)(B) (emphasis added). * * * To the extent that a borrower is able to provide reasons for a belief that the account is in error, the borrower should provide them, but any request for information made with sufficient detail is enough under RESPA to be a qualified written request and thus to trigger the servicer's obligations to respond. Id.\nIndeed, according to statute, the only other requirements for a communication to constitute a QWR is that it is \"written correspondence, other than notice on a payment coupon or other payment medium supplied by the servicer, that includes, other otherwise enables the servicer to identify, the name and account of the borrower[.]\"  12 U.S.C. \u00a7 2605(e)(1)(B).  \"By GMAC Mortgage's argument [and that of Defendant here], a lender would have no obligation to respond to a borrower who expressed her belief that her account was in error but was unable to provide specific reasons for that belief, an untenable result under the language of the statute.\" Catalan, 629 F.3d at 686.\nMr. Caines' correspondence to Defendant fulfilled all of the statutory requirements necessary to constitute a QWR and thus to trigger the protections of RESPA.  Therefore, Count I of his Complaint should not be dismissed for failure to state a claim upon which relief may be granted.\n2. Defendant Violated RESPA's Timeliness Requirements Anticipating that the Court might consider Mr. Caines' correspondence a proper QWR (which it clearly should), Defendant argued in the alternative that Mr. Caines' RESPA claim \"still fails because [Defendant] timely responded to Plaintiff's request . . . . \"  (Def.'s Br. in Supp. of Mot. to Dismiss 6).  Not so.  Defendant is mistaken in its construction of the law.\nEven if Defendant received Mr. Caines' QWR on July 11th, 2011 (as asserted by the Defendant) and not July 5, 2011 (as asserted under the complaint), he was not provided with a response until more than 60 days later.  There are two points to be made here: (1) the calculation should include July 11, and thus Mr. Caines should have had a response to his QWR no later than October 3, 2011; and (2) Defendant's response was only dated (and possibly sent) on October 4 - Mr. Caines was not provided with the information he requested until he received the response several days later."
                },
                {
                    "heading": "a. The 60-day time period calculation should include July 11, 2011.",
                    "content": "The governing statute, 12 U.S.C. \u00a7 2605(e) establishes the duties of a loan servicer to respond to borrower inquiries.  According to Defendant's math, the 60-day period begins on the day following the servicer's receipt of the QWR.  However, 12 U.S.C. \u00a7 2605(e)(3) is unequivocal in its instructions for the calculation of the 60-day period when it comes to the duty of a loan servicer to respond to borrower inquiries: \"During the 60-day period beginning on the date of the servicer's receipt from any borrower of a [QWR] . . . . \"  Granted, the subsection in question is \u00a7 2605(e)(2), but it strains logic to conclude that Congress meant for the 60-day period to begin on the day after receipt for the purposes of (e)(2), but that it should begin on the day of receipt for the purposes of the very next paragraph.\nBy Defendant's own admission, \"both [Defendant's] acknowledgement letter and response letter indicate the QWR was received on July 11, 2011.\"  (Def.'s Br. in Supp. of Mot. to Dismiss 6-7).  Since the 60-day time period calculation should include July 11, the \"not later than\" date by which Mr. Caines should have received a response pursuant to 12 U.S.C. \u00a7 2605(e)(2) was October 3.  However, as Defendant itself states, and as the relevant document evidences, the responsive letter was not even dated until October 4.  Thus it was not timely.\nb. Mr. Caines was not provided with a timely response.\nEven if the calculation of the relevant 60-day period should not include the day of receipt (which it clearly should), Defendant still failed to \"provide [Mr. Caines] with a written explanation or clarification\" by \"[n]ot later than 60 days . . . after the receipt\" of his QWR.  12 U.S.C. \u00a7 2605(e)(2)(C).  Mr. Caines was not provided with any information until he received it. Since Defendant's response wasn't even dated until October 4, Mr. Caines can hardly be considered to have been in receipt of the letter (i.e., provided with purportedly responsive information) until several days too late.\nThe whole purpose of RESPA is to improve communication to consumers: \"The Congress finds that significant reforms in the real estate settlement process are needed to insure that consumers throughout the Nation are provided with greater and more timely information on the nature and costs of the settlement process . . . .\"  12 U.S.C. \u00a7 2601(a).  It should be interpreted so as to provide consumers like Mr. Caines with the utmost protection, and servicers such as Defendant should be closely scrutinized and held to account for their \"certain abusive practices . . . .\"  Id.  Defendant cannot demonstrate that Mr. Caines failed to state a claim upon which relief may be granted vis-\u00e0-vis Defendant's violations of RESPA's timeliness requirements, and thus Defendant's motion to dismiss Count I of his Complaint should be denied."
                },
                {
                    "heading": "3. Defendant Violated Other Portions of RESPA",
                    "content": "Count I of Mr. Caines' Complaint was not limited to the untimeliness of Defendant's response to his QWR.  Indeed, Count I described Defendant's refusal to cease collection efforts and foreclosure proceedings after receipt of his QWR (a violation of 12 U.S.C. \u00a7 2605(3)(2)), and Defendant's provision of information to consumer reporting agencies regarding amounts related to the QWR (a violation of 12 U.S.C. \u00a7 2605(e)(3)).  (Pl.'s Compl. \u00b6\u00b6 53 and 54).  Since the correspondence from Mr. Caines to Defendant constituted a QWR, and since Defendant failed (in at least one way) to provide a timely response to Mr. Caines, Count I of the Complaint clearly states a claim upon which relief may be granted, and it should not be dismissed pursuant to Fed. R. Civ. P. 12(b)(6)."
                },
                {
                    "heading": "B. Count II: Indiana Home Loan Practices Act",
                    "content": "In the second count of his Complaint, Mr. Caines alleges a violation of the Indiana Home Loan Practices Act (IHLPA).  The IHLPA proscribes deceptive acts in connection with mortgage transactions.  Defendant seeks dismissal of this count for several reasons, each of which is discussed in detail below.  Because Defendant has failed to demonstrate that Count II of Mr. Caines' fails to state a claim upon which relief can be granted, the motion to dismiss it should be denied."
                },
                {
                    "heading": "1. Count II Was Properly Pled",
                    "content": "Contrary to Defendant's argument, Count II of Mr. Caines' Complaint met the pleading standards set by the Federal Rules of Civil Procedure, and it should not be dismissed for failure to state a claim under Fed. R. Civ. P. 12(b)(6)."
                },
                {
                    "heading": "a. Count II met the standards of Fed. R. Civ. P. 8.",
                    "content": "The Defendant's Motion to Dismiss claims that Mr. Caines Complaint for relief under IHLPA should be dismissed under Rule 12(b)(6) for failure to state a claim because Mr. Caines Complaint did not meet the standards set forth under Federal Rules of Civil Procedure Rule 8. \"[A] complaint attacked by a Rule 12(b)(6) motion to dismiss does not need detailed factual allegations . . . .\"  Id.  Yet detailed factual allegations are precisely what Mr. Caines provided Defendant in the first 49 paragraphs of his Complaint, and the allegations clearly demonstrate \"more than a sheer possibility that [Defendant] has acted unlawfully.\"  Ashcroft v. Iqbal, 557 U.S. 662, 129 S.Ct. 1937, 1949 (2009).  Mr. Caines pled facts that were more than \"'merely consistent with' [Defendant's] liability . . . .\" Id.  He pled \"factual content that allows the court to draw the reasonable inference that the defendant is liable for misconduct alleged.\"  Id.\n\"Federal Rule of Civil Procedure 8(a)(2) requires only 'a short and plain statement of the claim showing that the pleader is entitled to relief,' in order to 'give the defendant fair notice of what the . . . claim is and the grounds upon which it rests[.]'\"  Bell Atl. Corp. v. Twombly, 550 U.S. 544, 555, 127 S. Ct. 1955, 1964, 167 L. Ed. 2d 929 (2007) (citation omitted).  Despite what Defendant argues, Count II of Mr. Caines' Complaint meets this requirement, and it should not be dismissed for failure to state a claim.\nThere is a two-pronged approach to determining whether a complaint survives a Rule 8 challenge in a motion to dismiss for failure to state a claim.  Id. at 1950.\nThe first prong requires the court \"to begin by identifying pleadings that, because they are no more than conclusions, are not entitled to the assumption of truth.  While legal conclusions can provide the framework of a complaint, they must be supported by factual allegations.\"  Id. Mr. Caines' complaint contains factual allegation entitled to the assumption of truth and not merely legal conclusions providing a legal framework. Count II provides the framework for evaluating Defendant's liability under the IHLPA, and Paragraphs 1 through 49 of the Complaint, as well as the many exhibits to the Complaint, provide the factual allegations necessary to support it.  For example, the following information from the Complaint demonstrates the material misrepresentations that Defendants made to Mr. Caines:\n1. On May 28, 2009, Defendant sent notice to Mr. Caines advising him that his loan modification had been approved (Pl.'s Compl. \u00b6 17).\n2. On October 21, 2009, Defendant filed a Motion to Approve Loan Modification in Bankruptcy Court (Pl.'s Compl. \u00b6 20).\n3. On December 7, 2009, United States Bankruptcy Judge Frank J. Otte issued an order approving the loan modification. (Pl.'s Compl. \u00b6 22).\n4. On November 24, 2010, Defendant advised Mr. Caines that he was \"in serious default\" and that he had not made a monthly mortgage payment since March of 2010, despite the fact that Mr. Caines had made regular monthly payments of $2,205.00 from August of 2009 through November of 2010.  (Pl.'s Compl. \u00b6\u00b6 25- 27).\nAnd as shown with these allegations of the Complaint, Defendant's misrepresentations were known and/or intentional1:\n1. None of Mr. Caines' mortgage payments from April 2010 through and including November 2010 was returned as insufficient.  (Pl.'s Compl. \u00b6 24).\n2. Loan history documentation from Defendant demonstrates that it received regular monthly payments from Mr. Caines from July of 2009 through November of 2010.  (Pl.'s Compl. \u00b6 25).\n3. On October 21, 2009, Defendant filed a Motion to Approve Loan Modification in Bankruptcy Court (Pl.'s Compl. \u00b6 20).\n4. On December 7, 2009, United States Bankruptcy Judge Frank J. Otte issued an order approving the loan modification. (Pl.'s Compl. \u00b6 22). Defendant received a copy of said Order via the court's electronic filing system.\n5. On December 15, 2010, Mr. Caines filed a BBB Complaint indicating that he had persistently requested that BAC update their files to reflect the agreed-upon modified payment amount.  (Pl.'s Compl. \u00b6\u00b6 32, 33).\n6. On June 21, 2011, through counsel, Mr. Caines advised Defendant of its accounting errors in a QWR.  (Pl.'s Compl. \u00b6 44).\nAlthough these points are clearly indicative of deception related to a mortgage transaction, Defendant nonetheless suggests that Count II amounts to nothing more than a recitation of \"the elements of a cause of action without factual support, [and is thus] not sufficient to state a claim.\"  (Def.'s Br. in Supp. of Mot. to Dismiss 7).  This is false.\nSupported, as they are, with myriad exhibits, the foregoing are examples of the well- pleaded factual allegations within Mr. Caines' Complaint which are entitled to the assumption of truth.  Moving thus to the second prong, the \"court should assume their [factual pleadings entitled to the assumption of truth] veracity and then determine whether they plausibly give rise to an entitlement to relief.\"  Iqbal, 129 S.Ct. at 1950.  While plausibility is \"a context-specific task that requires the reviewing court to draw on its judicial experience and common sense[,]\" There is no doubt that the Complaint for relief under the IHLPA plausibly gives rise to an entitlement to relief.  Id.  It is more than merely \"conceivable\" that Defendant's conduct, as described in the facts of Mr. Caines' Complaint, violated the IHLPA.  Id. at 1951.  It is, indeed, plausible.  Defendant's actions are not \"compatible with,\" let alone \"more likely explained by, lawful . . . behavior.\"  Id. at 1950.\nb. Iqbal is distinguishable.\nIqbal is distinguishable and Defendant's reliance upon it is misplaced.  The 5/4-split decision reflects the fact-sensitive nature of the issues, and the dissenting opinions offer clarity with regard to Rule 8.\nIqbal began with the November, 2001 arrest of Javaid Iqbal, \"a citizen of Pakistan and a Muslim.\"  Id. at 1942.  Mr. Iqbal was arrested \"on charges of fraud in relation to identification documents and conspiracy to defraud the United States.\"  Id. at 1943.  He was subsequently \"designated a person 'of high interest' to the September 11 investigation and . . . placed in a section of the [detention center] known as the Administrative Maximum Special Housing Unit (ADMAX SHU).\"  Id.  \"ADMAX SHU detainees were kept in lockdown 23 hours a day, spending the remaining hour outside their cells in handcuffs and leg irons accompanied by a four-officer escort.\"  Id.  After Mr. Iqbal \"pleaded guilty to criminal charges, served a term of imprisonment, and was removed to his native Pakistan[, he] . . . filed a Bivens action . . . against 34 current and former federal officials and 19 'John Doe' federal corrections officers.\"  Iqbal, 129 S.Ct. at 1943.  Among the defendants he named in his complaint were John Ashcroft and Robert Mueller. 2\nAlthough the Court recognized Iqbal's \"account of his prison ordeal could, if proved, demonstrate unconstitutional misconduct by some governmental actors[, . . .] the allegations and pleadings with respect to [those] actors [were] not before [them there].\"  Id. at 1942.  The only petitioners before the Supreme Court were Ashcroft and Mueller (hereinafter \"petitioners\"), and the \"allegations against petitioners [were] the only ones relevant [there].\"  Id. at 1944.  Thus, the only issue was whether \"respondent, as the plaintiff in the District Court, plead factual matter that, if taken as true, state[d] a claim that petitioners deprived him of his clearly established constitutional rights.\"  Iqbal, 129 S.Ct. at 1942-43.\nThe court applied the two prong test to determine whether the Iqbal's complaint survived a Rule 8 challenge via a motion to dismiss for failure to state a claim. In its application of the first prong, the court eliminated allegations which were merely legal conclusion and not entitled to the assumption of truth. Id at 1951. To apply the second prong, the court first identified the following factual pleadings entitled to the assumption of truth."
                },
                {
                    "heading": "1) \"the [FBI], under the direction of Defendant MUELLER, arrested and detained thousands of Arab Muslim men . . . as part of its investigation of the events of September 11.\"",
                    "content": "2) [t]he policy of holding post-September-11th detainees in highly restrictive conditions of confinement until they were 'cleared' by the FBI was approved by Defendants ASHCROFT and MUELLER in discussions in the weeks after September 11, 2001.\" Id.\nThe court despite assuming the truth of the above facts, found Iqbal's complaint insufficient and incompliant with Federal Rules of Civil Procedure Rule 8. The \"constitutional claims against petitioners rest[ed] solely on their ostensible 'policy of holding post-September- 11th detainees' in the ADMAX SHU once they were categorized as 'of high interest.'\"  Id. at 1952.  The Court reflected that to \"prevail on that theory, the complaint must contain facts plausibly showing that petitioners purposefully adopted a policy of classifying post-September- 11 detainees as 'of high interest' because of their race, religion, or origin.  [And the Court determined that] this the complaint fail[ed] to do.\"  Id.  \"The court did not find the factual pleadings entitled to the assumption of truth \"sufficient to plausibly suggest petitioners' discriminatory state of mind[,] Accepting the truth of that allegation, the complaint does not show, or even intimate, that petitioners purposefully housed detainees in the ADMAX SHU due to their race, religion, or national origin. All it plausibly suggests is that the Nation's top law enforcement officers, in the aftermath of a devastating terrorist attack, sought to keep suspected terrorists in the most secure conditions available until the suspects could be cleared of terrorist activity. Respondent does not argue, nor can he, that such a motive would violate petitioners' constitutional obligations. He would need to allege more by way of factual content to \"nudg[e]\" his claim of purposeful discrimination \"across the line from conceivable to plausible.\" Id.  Consequently, the court determined that Mr. Iqbal's pleadings did \"not meet the standards necessary to comply with Rule 8.\"  Id.\nIqbal's case is factually distinguishable from the case at hand. Mr. Caines complaint is strongly supported by facts, and if the court assumes their veracity (which it should) said factual allegations should plausibly give rise to an entitlement to relief.\"  Iqbal, 129 S.Ct. at 1950. Defendants suggest that Mr. Caines \"failed to plead any facts to support his claim that [they] knowingly or intentionally made a material representation or concealed material information regarding the terms or conditions of his transaction, and instead merely concludes that [they] did so.\"  (Def.'s Br. in Supp. of Mot. to Dismiss 8).  However, Mr. Caines alleged multiple facts to support his claim.  Paragraphs 32, 33, and 38 show that Mr. Caines tried to contact Defendant and notify them of their mistakes.  He even filed a complaint with the Better Business Bureau, which was acknowledged by Defendant. Pl. Complaint Para. 33.  Moreover, the accounting was again disputed in the QWR sent by Mr. Caines' attorney in June. Id. Para. 45. Despite these numerous attempts by Mr. Caines to obtain relief, Defendant continued to misapply payments and deceptively (1) represented to Mr. Caines that his account was delinquent, and (2) reported Mr. Caines' account as delinquent to the credit reporting agencies. Id. Para. 54, and Exhibit G.\nMoreover, Defendant knew of the modified payment structure to which they were supposed to adhere because it participated in preparing a joint motion for court approval of a loan modification, which was subsequently approved by the Court. Id. Exhibit D & E. A notice of said approval was sent to the Defendants via the electronic mailing system operated by the Bankruptcy Court.  These facts also demonstrate that Defendant had the actual knowledge necessary to trigger their liability under the IHLPA.\nIt is also important to note that Four Justices vehemently dissented to the ruling in Iqbal.3 They noted, \"According to the complaint, Ashcroft and Mueller 'knew of, condoned, and willfully and maliciously agreed to subject Iqbal to these conditions of confinement as a matter of policy, solely on account of his religion, race, and/or national origin and for no legitimate penological interest.'\"  Iqbal, 129 S.Ct. at 1959 (Souter, J., dissenting).\nThe complaint thus alleges, at a bare minimum, that Ashcroft and Mueller knew of and condoned the discriminatory policy their subordinates carried out. Actually, the complaint goes further in alleging that Ashcroft and Muller [sic] affirmatively acted to create the discriminatory detention policy.  If these factual allegations are true, Ashcroft and Mueller were, at the very least, aware of the discriminatory policy being implemented and deliberately indifferent to it. * * * Twombly does not require a court at the motion-to-dismiss stage to consider whether the factual allegations are probably true.  We made it clear, on the contrary, that a court must take the allegations as true, no matter how skeptical the court may be.  See Twombly . . . (a court must proceed \"on the assumption that all the allegations in the complaint are true (even if doubtful in fact)\"); (\"[A] well- pleaded complaint may proceed even if it strikes a savvy judge that actual proof of the facts alleged is improbable\"); see also Neitzke v. Williams, (\"Rule 12(b)(6) does not countenance . . . dismissals based on a judge's disbelief of a complaint's factual allegations\").  The sole exception to this rule lies with allegations that are sufficiently fantastic to defy reality as we know it: claims about little green men, or the plaintiff's recent trip to Pluto, or experiences in time travel.  That is not what we have here.\nId. (internal pinpoint citations omitted) (emphasis added).\nUltimately, Mr. Caines' Complaint \"must be construed so as to do justice.\"  Fed. R. Civ. P. 8(e).  Given that his factual allegations must be accepted as true, Mr. Caines has provided ample facts to suggest illegal conduct. Consequently, Count II of his Complaint should not be dismissed as insufficient under Fed. R. Civ. P. 8."
                },
                {
                    "heading": "2. The Requirements of Rule 9(b) Are Met",
                    "content": "Defendant argues that Count II amounted to \"nothing more than allegations of misrepresentation or fraud[, and thus should have been] pleaded with specificity.\"  (Def.'s Br. in Supp. of Mot. to Dismiss 8).  However, the specific pleading requirements of Rule 9(b) were met.\nDefendant is correct in asserting that Mr. Caines' claims vis-\u00e0-vis the IHLPA likely require specific pleading.  Further research has produced McKinney v. State, 693 N.E.2d 65, 71- 73 (Ind. 1998), in which the Court examined whether the edicts of Rule 9(b) applied to claims brought under the Indiana Deceptive Consumer Sales Act.4  The Court held \"that for actions under the [Indiana Deceptive Consumer Sales] Act that are 'grounded in fraud,' the specificity requirement of Rule 9(B) must be met.\" 5  Id. at 71.\nAssuming arguendo that specific pleading was required, that requirement was met.  \"[T]o satisfy the requirements of Rule 9(b), it is not even necessary to plead each element of fraud in detail so long as the 'circumstances constituting fraud' are stated with particularity.\"  ABN Amro Mortg. Group, Inc. v. Maximum Mortg., Inc., 429 F.Supp.2d 1031, 1038 (N.D. Ind. 2006) (quoting U.S. v. Lutheran Hospital, No. CIV. 1:97C-174, 1998 WL 1753335, at *6 (N.D. Ind.\nApril 17, 1998)).  \"[T]he requirements of Rule 9(b) 'are not absolute or unbounded; defendants need not be given a pretrial memorandum containing all of the evidentiary support for plaintiff's case.'\"  Lutheran Hospital, 1998 WL 1753335 at *6 (quoting Uniroyal Goodrich Tire Co. v. Mutual Trading Corp., 749 F.Supp. 869, 872 (N.D.Ill. 1990)).  \"The Seventh Circuit has described Rule 9(b)'s particularity requirement as follows: 'What a claim of fraud must include . . . is 'particularity' about the details-'the who, what, when, where, and how: the first paragraph of any newspaper story.''\"  ABN Amro Mortg. Group, Inc., 429 F.Supp.2d at 1038.\nBecause Count II of the Complaint incorporated all of the facts alleged and exhibits included, it clearly met the requirements of Rule 9(b):\nWho: The \"who\" is clearly Bank of America.  It is the only defendant named and all of the exhibits demonstrate the multiple complaints against it.  At this early stage of the proceedings, it should not be Mr. Caines' burden to determine which of Defendant's 132,749 employees made the misrepresentations.6  Moreover, if Mr. Caines did know the identities of any individual offending party, it was because that party signed a document.  All signed documents were attached to, incorporated with, and made a part of the Complaint.  Thus, the \"who\" requirement is satisfied.\nWhat: Each and every time Mr. Caines contacted Defendant, he was telling him \"what\" was wrong with their accounting.  When Mr. Caines filed his complaint with the BBB, he was telling them \"what\" was wrong with their accounting.  When Mr. Caines' attorney sent Defendant a QWR, he was telling him \"what\" was wrong with their accounting. Defendant cannot now pretend they have no idea what this Complaint is about.  These are again explained in the Complaint and through the attached and incorporated exhibits.  \"Clearly, [Mr. Caines] has provided 'fair notice to the defendant' of the circumstances surrounding the alleged fraud.\"  Id. at 1040.  The \"what\" is sufficiently pled in the Complaint.\nWhen: The facts in the Complaint (many of which are dated with the month, day, and year), and the exhibits to the Complaint, \"clearly set[] forth the time frame in which the fraud occurred.\"  Id. The date of each alleged deceptive representation is discernible from the Complaint and its Exhibits.\nWhere: The Complaint \"also sufficiently alleges the 'where' or 'by what means' of the fraud.\"  Id.  The Exhibits to the Complaint provide the notices that Mr. Caines received from Defendant through which Defendant makes material misrepresentations about his account. (Pl. Complaint Exhibits F, G, H) Furthermore, Defendant continued reporting Mr. Caines as delinquent after receiving Mr. Caines dispute via a qualified written request and before responding to said dispute. Pl. Complaint Para 54.   Said behavior was not only deceptive under IHLPA but also a violation of RESPA.\nHence, because all of the requirements of Rule 9(b) are thus met, Defendant's motion for dismissal of Count II for failure to plead fraud with specificity should be denied."
                },
                {
                    "heading": "3. Defendant Waived Any Right to Object for Non-Compliance",
                    "content": "Defendant argues that Mr. Caines' allegations of IHLPA violations should be dismissed because \"he violated nearly every condition\" of the conditional loan modification offer (hereinafter the \"Offer\").  (Def.'s Br. in Supp. of Mot. to Dismiss 9).  In fact, Defendant goes so far as to suggest \"Plaintiff's own rendition of the facts indicates he violated nearly every condition[.]\"  (Id.)  This is simply false.  Mr. Caines specifically stated the he performed all conditions precedent to recover under the contract.  (Pl.'s Compl. \u00b6  69).  Additionally, Mr.\nCaines believes that further discovery will reveal more of the inaccuracies in Defendant's argument.\nIn any event, Defendant waived any non-performance on the part of Mr. Caines when it participated with Mr. Caines in filing a joint motion for approval of the loan modification in October of 2009.  If any of the alleged compliance issues had existed, Defendant would not have filed that motion.  Even if there were such issues, the motion indicates that both parties entered into an agreement (\"negotiated a loan modification\").  Defendant cannot now take the position that a loan modification never occurred.  This is a straightforward issue of judicial estoppel. Judicial estoppel is a doctrine intended to prevent the perversion of the judicial process. Edwards v. Aetna Life Ins. Co., 690 F.2d 595, 599 (6th Cir.1982). It is to be applied where \"intentional self-contradiction is being used as a means of obtaining unfair advantage in a forum designed for suitors seeking justice,\" Scarano v. Central R. Co., 203 F.2d 510, 513 (3d Cir.1953), to prevent litigants from \"playing fast and loose with the courts.\" Id. \"Where a party assumes a certain position in a legal proceeding, and succeeds in maintaining that position, he may not thereafter, simply because his interests have changed, assume a contrary position.\""
                },
                {
                    "heading": "Matter of Cassidy, 892 F.2d 637, 641 (7th Cir. 1990)",
                    "content": "Furthermore, Defendants actions are also in direct contradiction with the court order dated December 7th, 2009.  (Pl.'s Compl. \u00b6 22).  The court order approved the Motion for Loan Modification filed jointly by Mr. Caines and the Defendant. Id. Hence a breach of the conditional modification agreement prior to this order should not discharge Defendants of their contractual duties after said order was issued.\nEven if Defendant is not judicially estopped from denying the existence of a loan modification (which it is) or bound by the court order referenced above, there is still a factual dispute about whether the terms of the agreement were violated.  The Conditional Agreement requires that: (1) Mr. Caines makes the first payment on July 1st, 2009 and on same date of each month thereafter; (2) Mr. Caines provides income information (by an unspecified date) and a few other specified documents by June 11th, 2009; (3) Lender obtaining Title-insurance; and (4) Bank of America receiving relief from stay from any ongoing bankruptcy proceeding. Pl. Complaint, Exhibit C. Mr. Caines contends in his Complaint for relief that he had met all conditions precedent for this Conditional Modification Agreement. Id. at \u00b6 69.  Requirement (3) of the agreement does not state that Mr. Caines would be responsible for filing the motion for relief from stay, but that the bank should be able to obtain such relief.  From a practical standpoint, this is simply not the sort of motion filed by a debtor, since it is entirely for the benefit of the creditor.  Understandably, Mr. Caines did not interpret this provision of the agreement to mean that he would need to file such a motion, but that rather that he would not oppose it. Similarly, requirement (4) was also contingent on Defendant obtaining title insurance. Defendant never contacted Mr. Caines regarding any liens on his property or for his assistance in acquiring said insurance. Hence, in light of the joint Motion for Loan modification and lack of any correspondence suggesting otherwise, Mr. Caines was right in assuming that requirement (4) was fulfilled.\nSince Count II of the Complaint complies with Rules 8 and 9, and since Defendant should be judicially estopped from pretending that a loan modification agreement was never reached, Count II should not be dismissed for failure to state a claim upon which relief may be granted."
                },
                {
                    "heading": "1. Breach of Contract",
                    "content": "In its Motion to Dismiss, Defendant claims that Plaintiff, by his own admission, breached the conditional loan modification agreement and hence his Breach of Contract claim should be dismissed for failure to state a claim under Rule 12(b).  (Def.'s Br. in Supp. of Mot. to Dismiss 9).  Mr. Caines has adequately stated a claim for breach of contract.  As explained in the preceding sections, Defendant filed a motion with the court indicating that a contract (the modification agreement) had successfully been negotiated.  (Pl. Complaint Exhibit D.)  Hence, the Defendants should be judicially estopped from claiming that there was no modification agreement between the parties.\nFurthermore, Defendants actions and claims are also in direct contradiction with the court order dated December 7th, 2009. (Pl.'s Compl. \u00b6 22.)  The court order approved the Motion for Loan Modification filed jointly by Mr. Caines and the Defendant. Id. Hence a breach of the conditional modification agreement prior to this order should not discharge Defendants of their contractual duties after said order was issued.\nEven if Defendant is not judicially estopped from denying the existence of a loan modification (which it is) or bound by the court order referenced above, Defendants claim that Mr. Caines breached the conditional modification agreement is also inaccurate. The Conditional Agreement requires that: (1) Mr. Caines makes the first payment on July 1st, 2009; (2) Mr. Caines provides income information (by an unspecified date) and a few other specified documents by June 11th, 2009; (3) Lender obtaining Title-insurance; and (4) Bank of America receiving relief from stay from any ongoing bankruptcy proceeding.  (Pl. Compl., Exhibit C). Mr. Caines contends in his Complaint that he had met all conditions precedent for this Conditional Modification Agreement. Id. at \u00b6 69. Defendants claim that Mr. Caines did not comply with requirement (1) and \"failed to perform under the contract by his own admission . . . .\" (Def.'s Br. in Supp. of Mot. to Dismiss 9) by making late payments. Mr. Caines did no such thing.  The dates provided in his Complaint represented the dates that Defendant posted Mr. Caines payments, and not the dates on which they were sent or received.\nContrary to Defendants claims, Requirement (3) of the agreement does not state that Mr. Caines would be responsible for filing the motion for relief from stay, but that the bank should be able to obtain such relief.  From a practical standpoint, this is simply not the sort of motion filed by a debtor, since it is entirely for the benefit of the creditor.  Understandably, Mr. Caines did not interpret this provision of the agreement to mean that he would need to file such a motion, but rather that he would not oppose it. Similarly, requirement (4) was also contingent on Defendant obtaining title insurance. Defendant never contacted Mr. Caines regarding any liens on his property or for his assistance in acquiring said insurance. Hence, in light of the joint Motion for Loan modification and any lack of correspondence suggesting otherwise, Mr. Caines was right in assuming that requirement (4) was fulfilled.\nBased on the aforementioned arguments, Plaintiff asserts that his complaint for Breach of Contract should not be dismissed. Defendant's contention that no loan modification agreement exists between the parties is contrary to principles of Judicial Estoppel and in direct contradiction with a court order issued by a Bankruptcy court judge upon a joint motion by the Parties. Furthermore, even if said court order or principles of Judicial Estoppel were ignored, Plaintiffs complied with the terms of the Conditional Modification Agreement and there is no reason why Defendants should not hold their end of the bargain."
                },
                {
                    "heading": "2. Promissory Estoppel and Estoppel",
                    "content": "Mr. Caines has adequately stated a claim for promissory and equitable estoppel, and those claims should not be dismissed under Rule 12(b)(6).  When the Complaint is read as a whole, with the well-pleaded factual allegations construed in favor of Mr. Caines, it is clear that these claims should not be dismissed."
                },
                {
                    "heading": "a. Promissory Estoppel",
                    "content": "There are five elements to a claim of promissory estoppel: (1) a promise (2) made with the expectation of reliance thereon, (3) which induces reasonable reliance (4) of a definite and substantial nature, and (5) injustice can be avoided only by enforcement of the promise.  D & G Stout, Inc. v. Bacardi Imports, Inc., 805 F. Supp. 1434, 1444 (N.D. Ind. 1992).  Mr. Caines' Complaint demonstrates that each of these elements is met. In the following paragraphs we will address each of these elements individually and address the relevant claims made by the Defendant.\ni. A Promise:\nMr. Caines was promised a loan modification by the Defendant. The promise was made via several representation made to Mr. Caines by the Defendant including but not limited to: (1) Conditional Loan Modification Offer (Pl. Complaint Exhibit C); (2) discussions between counsels from either party leading up to the filing of the Joint Motion for Approval of Loan Modification; and (3) the Joint Motion for Approval of Loan Modification Pl. Complaint Exhibit D).\nDefendant argues that the only representations made to Mr. Caines were those made in the original mortgage and the conditional modification agreement.  Based on these two agreements, Defendant suggests, that Mr. Caines was in breach because he did not comply with the terms of the Conditional Modification Agreement.  Perhaps this is an \"unclean hands\" defense to Mr. Caines' prayer for equitable relief, but whatever the ilk of the argument, it fails.\nDefendant's contention fails because: (1) Defendant is judicially estopped from arguing as such due to representations made by the Defendant in Bankruptcy Court (Pl. Complaint Exhibit D); (2) Defendant's arguments are in contradiction with a Bankruptcy Court Order (PL. Complaint Exhibit E); and (3) as discussed previously in section C1 of this Response, Mr. Caines did in fact comply with the terms of the Conditional Modification Agreement.\nDefendant also claims that even if there was in fact a Loan Modification, Mr. Caines was late in his payments following said Loan Modification pursuant to the provisions of the original Note and Mortgage and consequently Defendants should be allowed to move forward with a collection action. Def.'s Br. in Supp. of Mot. to Dismiss 12. This argument is flawed for several reasons addressed in the following paragraphs.\nIt is important to note at this juncture that if the Loan Modification is assumed confirmed, Defendant would immediately be obliged under the terms of the Note and Mortgage to appropriately apply the payments made by Mr. Caines. Pl. Complaint Exhibit A, 4. Furthermore, based on the loan history and other documents provided by the Defendant (Pl. Complaint Exhibit F), Defendant would be in breach of its agreement with Mr. Caines due to its misapplication of monthly mortgage payments.\nEven if we move past this immediate breach, Defendant is only contractually allowed to move forward with a collection action after providing Mr. Caines with a Notice of Default allowing 30 days to cure the default. Pl. Complaint. Exhibit B. As previously stated, the payment dates included in the Complaint are dates when the payments were posted and not the date of receipt or the date checks were mailed out.  However, even if Defendant is correct and payments were in fact late, Defendant had a contractual duty to send out a Notice of Default allowing 30 days to cure. The only such letter ever sent out was on November 24, 2010. Pl. Complaint Exhibit G. Defendant's own records indicate that: (1) a payment for November 2010 was posted on November 16, 2010; and (2) Mr. Caines made a modified loan mortgage payment of $2265 every month between July 2009 (beginning of the loan modification term) and November 2010 (month the Notice of Intent to Accelerate was received). Pl. Complaint Para 25. E. If we assume that a loan modification was in place and Defendant's records are accurate, Mr. Caines was not behind on his payments and any alleged default was already cured within the contractually permitted 30 day time frame even prior to the receipt of Defendant Notice of Intent to Accelerate.\nMr. Caines missed payments for December 2010, January 2011, and February 2011 following the receipt of Defendant's Notice of Intent to accelerate. However, by this time Defendants were already in material breach of any Modification Agreement between the parties and Mr. Caines would have been ill-advised to continue making payments when such payments being inappropriately applied to his account. Furthermore, Mr. Caines missed those payments on the advice of his legal counsel at the time. Once he terminated the services of said legal counsel he continued making payments as is evident from Defendants own records. Pl. Complaint Para 25.\nii. Expectation and Inducement of Reliance of a Definite and Substantial Nature:\nDefendant via its actions and inactions induced reliance by Mr. Caines on its promises to modify his mortgage loan. Defendant sent a Conditional Modification Offer (Pl. Complaint Exhibit C), following which no other communication was sent to Mr. Caines until parties discussed and filed a joint modification agreement in Bankruptcy court. Pl. Complaint Exhibit C,D. All payments sent by Mr. Caines towards said Modification Agreement were accepted and even a court order confirming the loan modification was issued upon a joint motion by the parties. Pl. Complaint. Exhibit E. Defendant clearly expected that Mr. Caines would rely on the agreements.  If he failed to do so, then Mr. Caines would face the loss of his home.  As a result, Mr. Caines reasonably relied upon Defendant's promises regarding the modification of the terms of his mortgage.  Each time that Mr. Caines sent Defendant a payment, he was relying on Defendant's promises - months of such payments certainly rise to the level of being \"definite and substantial.\"\nInjustice Can Only Be Avoided By Enforcement: Mr. Caines faces foreclosure as a result of his reliance on the modification agreement.  If ever there was an example of justice requiring the enforcement of a promise, this is it.\nMr. Caines' Complaint for relief pursuant to the doctrine of promissory estoppel should not be dismissed for failure to state a claim. The following paragraphs will discuss each of these elements individually and address the relevant claims made by the Defendant."
                },
                {
                    "heading": "b. Equitable Estoppel",
                    "content": "Although the word \"equitable\" was erroneously omitted from Mr. Caines' Complaint, the description of the elements of the Count simply labeled \"Estoppel\" clearly indicate that Mr. Caines seeks relief through the doctrine of equitable estoppel.  \"The traditional elements of equitable estoppel are: 1) misrepresentation by the party against whom estoppel is asserted; 2) reasonable reliance on that misrepresentation by the party asserting estoppel; and 3) detriment to the party asserting estoppel.\"  United States v. Martell, 844 F. Supp. 454, 458 (N.D. Ind. 1994).\nThe elements of equitable estoppel are perfectly met by the circumstances of this case, and this count of Mr. Caines' Complaint should not be dismissed for failure to state a claim.\nMisrepresentation: At this point, the misrepresentations made by Defendant are well established.  As previously stated, Defendant: (1) sent a Conditional Loan Modification Offer to Mr. Caines (Pl. Complaint Exhibit C); (2) made representations confirming the Loan Modification during discussions leading up to the filing of the Joint Motion for Approval of Loan Modification in Bankruptcy Court; (3) Defendant filed Joint Motion for Approval of Loan Modification in Bankruptcy Court (Pl. Complaint Exhibit D); (4) neither sent any correspondence nor communicated any concerns or reasons for breach of the Conditional Modification Agreement to Mr. Caines at any time after the offer for Conditional Modification was sent and before the Notice of Acceleration was received by Mr. Caines. All of Defendant's actions and inactions only strengthened Mr. Caines belief that a Loan Modification was in place. However, as is evident by Defendant's conduct all of the aforementioned representations were false (or else the need for this litigation would be obviated).\nReasonable Reliance: Mr. Caines did in fact rely on the aforementioned misrepresentations as is evident from his monthly mortgage payments in the amount set-forth by the terms of the loan modification. Mr. Caines' reliance on the representations made privately by Defendant to him were reasonable. Even if Defendant persuades the Court that Mr. Caines failed to perform his obligations under the private modification agreement (an unclean hands argument, perhaps?), Mr. Caines can absolutely not be faulted for relying on the agreement filed with and approved by the Bankruptcy Court.7 It would not only be unreasonable but also irresponsible of 7 By this argument, Mr. Caines does not concede that a legitimate agreement did not exist until the modification agreement filed with the Bankruptcy Court. As discussed supra, Defendant Mr. Caines to disregard the provisions of a Loan Modification approved via a Court Order upon a Joint Motion filed by both parties.\nDetriment: Mr. Caines is facing foreclosure and his credit is damaged.  He has incurred, and is incurring, substantial legal fees in his efforts to save his home.  Clearly, his reliance on Defendant's representations has proved to be to his detriment.\nMr. Caines' reliance on the agreement, and the damages that he suffered as a result of Defendant's breach (as described throughout the Complaint), entitle him to the relief of promissory estoppel and equitable estoppel. Hence, Mr. Caines' claims for promissory estoppel and equitable estoppel should not be dismissed for failure to state a claim."
                },
                {
                    "heading": "D. Count IV: Breach of Good Faith and Fair Dealing",
                    "content": "Count IV of Mr. Caines' Complaint should not be dismissed for failure to state a claim. Defendant construes the requirements for the creation of a fiduciary relationship between a lender and borrower too narowly, and thus Mr. Caines should be permitted to pursue his case for a breach of good faith and fair dealing.\nA fiduciary relationship does not exist between a lender and a borrower unless certain facts exist which establish a relationship of trust and confidence between the two. A confidential relationship exists whenever confidence is reposed by one party in another with resulting superiority and influence exercised by the other. Not only must there be confidence by one party in the other, but the party reposing the confidence must also be in a position of inequality, dependence, weakness, or lack of knowledge. Furthermore, it must be shown that the dominant party wrongfully abused this confidence by improperly influencing the weaker so as to obtain an unconscionable advantage. Whether such a relationship exists is essentially a question of fact.\nwaived any non-compliance issues when it filed the joint motion in the bankruptcy proceeding, and Defendant should be judicially estopped from asserting the absence of an agreement in this case.\nKruse v. Nat'l Bank of Indianapolis, 815 N.E.2d 137, 149 (Ind. Ct. App. 2004). Mr. Caines trusted Defendant with the modification of his loan and the proper posting of his payments.  He was one man up against an enormous corporation.  His was undoubtedly a position of \"inequality, dependence, weakness, or lack of knowledge.\"  Defendant abused Mr. Caines' trust when it reneged on the agreement that it filed with the Court.  Because this is a question of fact that should be construed in favor of Mr. Caines, his complaint for a breach of good faith and fair dealing should not be dismissed for failure to state a claim."
                }]

initial_state = ArgumentAnalysisState(
    messages=[],
    argument=argument,
    responses=responses_list,
    verified_responses=None,
    tool_status={}
)

# Define a config, needed for CopilotKit state emission
# In a real app, this config would be passed down from the request handler
config: RunnableConfig = {"configurable": {"user_id": "test-user", "thread_id": "test-thread"}}

# Invoke the graph
# Use stream or invoke depending on how you want to get results
final_state = app.invoke(initial_state, config=config)

print("\n--- Final State ---")
print(f"Verified Responses: {final_state.get('verified_responses')}")
# print(f"Full Message History: {final_state.get('messages')}")